{% extends 'base.html' %}

{% block title %}Dettaglio Richiesta ID: {{ richiesta.id }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Dettaglio Richiesta</h2>
            <p class="lead text-muted">
                Stato: 
                {% if richiesta.stato == StatoRichiesta.BOZZA %}
                    <span class="badge bg-warning text-dark">In Bozza</span>
                {% elif richiesta.stato == StatoRichiesta.ISTRUTTORIA %}
                    <span class="badge bg-info">In Istruttoria</span>
                {% elif richiesta.stato == StatoRichiesta.ISTRUITA %}
                    <span class="badge bg-success">Istruita</span>
                {% endif %}
            </p>
        </div>
        <div>
             {% if richiesta.stato == StatoRichiesta.BOZZA %}
            <a href="{{ url_for('richiesta.controlla_richiesta', richiesta_id=richiesta.id) }}" class="btn btn-success btn-lg" title="Vai alla pagina di controllo finale">
            <i class="fas fa-check-double me-1"></i> Controlla e Trasmetti
            </a>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Riepilogo Dati Generali</h5></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Evento</dt>
                <dd class="col-sm-9">{{ richiesta.evento.nome }}</dd>
                <dt class="col-sm-3">Protocollo di Attivazione</dt>
                <dd class="col-sm-9">{{ richiesta.evento.protocollo_attivazione }}</dd>
                <dt class="col-sm-3">Attività Svolta</dt>
                <dd class="col-sm-9">{{ richiesta.attivita_svolta }}</dd>
            </dl>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-spese">Riepilogo Spese</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-impieghi">Riepilogo Impiego Mezzi</a>
                </li>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-documenti">Riepilogo Documenti</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-comunicazioni">Comunicazioni</a>
                </li>

            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-spese">
                     {% if richiesta.stato == StatoRichiesta.BOZZA %}
                    <a href="{{ url_for('richiesta.crea_spesa', richiesta_id=richiesta.id) }}" class="btn btn-primary mb-3">
                        <i class="fas fa-euro-sign me-1"></i> Aggiungi Spesa
                    </a>
                    {% endif %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th class="text-end">Importo</th>
                                <th class="text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spesa in richiesta.spese %}
                            <tr>
                                <td>{{ spesa.categoria }}</td>
                                <td>{{ spesa.descrizione_spesa }}</td>
                                <td class="text-end">&euro; {{ "%.2f"|format(spesa.importo_richiesto) }}</td>
                                <td class="text-center">
                                     <a href="{{ url_for('richiesta.lista_documenti', spesa_id=spesa.id) }}" class="btn btn-info btn-sm" title="Gestisci documenti">
                                         <i class="fas fa-file-alt"></i>
                                         <span class="badge bg-light text-dark ms-1">{{ spesa.documenti|length }}</span>
                                      </a>
                                      {% if richiesta.stato == StatoRichiesta.BOZZA %}
                                       <a href="{{ url_for('richiesta.aggiungi_documenti_spesa', spesa_id=spesa.id) }}" class="btn btn-success btn-sm" title="Aggiungi documento">
                                            <i class="fas fa-plus"></i>
                                       </a>
                                       <a href="{{ url_for('richiesta.modifica_spesa', richiesta_id=richiesta.id, spesa_id=spesa.id) }}" class="btn btn-warning btn-sm" title="Modifica spesa">
                                            <i class="fas fa-edit"></i>
                                       </a>
                                        <form action="{{ url_for('richiesta.cancella_spesa', richiesta_id=richiesta.id, spesa_id=spesa.id) }}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-danger btn-sm" title="Cancella spesa" onclick="return confirm('Sei sicuro di voler cancellare questa spesa?');">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted">Nessuna spesa inserita.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="tab-impieghi">
                   {% if richiesta.stato == StatoRichiesta.BOZZA %}
                    <a href="{{ url_for('richiesta.crea_impiego', richiesta_id=richiesta.id) }}" class="btn btn-primary mb-3">
                        <i class="fas fa-truck me-1"></i> Aggiungi Impiego Mezzo
                    </a>
                    {% endif %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mezzo</th>
                                <th>Località</th>
                                <th>Periodo</th>
                                <th class="text-end">Km Totali</th>
                                <th class="text-center">N. Spese collegate</th>  {# Nuova colonna #}
                                <th class="text-center">Azioni</th>  {# Nuova colonna #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for impiego in richiesta.impieghi %}
                            <tr>
                                <td>{{ impiego.mezzo_attrezzatura.targa_inventario }}</td>
                                <td>{{ impiego.localita_impiego }}</td>
                                <td>{{ impiego.data_ora_inizio_impiego.strftime('%d/%m %H:%M') }}</td>
                                <td class="text-end">
                                    {{ "%.2f"|format(impiego.km_totali) if impiego.km_totali else 'N/A' }} km
                                </td>
                                <td class="text-center">
                                        {{
                                            richiesta.spese
                                            | selectattr('impiego_id', 'equalto', impiego.id)
                                            | list
                                            | length
                                        }}
                                </td>
                                <td class="text-center">
                                    {% if richiesta.stato == StatoRichiesta.BOZZA %}
                                   <a href="{{ url_for('richiesta.modifica_impiego', richiesta_id=richiesta.id, impiego_id=impiego.id) }}" class="btn btn-sm btn-warning me-1">
                                    <i class="fas fa-edit"></i> Modifica
                                    </a>
                                    {#
                                    <form action="{{ url_for('richiesta.cancella_impiego', richiesta_id=richiesta.id, impiego_id=impiego.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Sei sicuro di voler cancellare questo impiego?');">
                                        <i class="fas fa-trash-alt"></i> Cancella
                                    </button>
                                    </form>
                                    {#}
                                    {% endif %}
                               </td>                                 
                             </tr>
                             {% else %}
                            <tr><td colspan="3" class="text-center text-muted">Nessun impiego registrato.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="tab-documenti">
                    <h5 class="card-title mb-3">Elenco completo dei documenti caricati</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Spesa di Riferimento</th>
                                <th>Tipo Documento</th>
                                <th>Data</th>
                                <th>Fornitore</th>
                                <th>Importo</th>
                                <th class="text-end">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Usiamo un doppio ciclo per scorrere i documenti di ogni spesa #}
                            {% for spesa in richiesta.spese %}
                                {% for doc in spesa.documenti %}
                                <tr>
                                    <td>{{ spesa.descrizione_spesa | truncate(30) }}</td>
                                    <td>{{ doc.get_tipo_documento_display() }}</td>
                                    <td>{{ doc.data_documento.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ doc.fornitore or 'N/D' }}</td>
                                    <td class="text-end">&euro; {{ "%.2f"|format(doc.importo_documento) }}</td>
                                    <td class="text-end">
                                        {%if richiesta.stato=='A'%}
                                        <a href="{{ url_for('richiesta.modifica_documento', spesa_id=spesa.id, richiesta_id=richiesta.id, documento_id=doc.id) }}" class="btn btn-warning btn-sm" title="Modifica documento">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {%elif doc.nome_file%}
                                        <a href="{{ url_for('richiesta.download_documento', spesa_id=spesa.id, richiesta_id=richiesta.id, documento_id=doc.id) }}" class="btn btn-info btn-sm" title="Scarica documento">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Nessun documento inserito per questa richiesta.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="tab-comunicazioni">
                    <div class="card border-0">
                        <div class="card-body p-0">
                            {% include 'partials/_comunicazioni_content.html' %}
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
        </a>
    </div>

{% endblock %}