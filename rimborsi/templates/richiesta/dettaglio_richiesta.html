{% extends 'base.html' %}

{% block title %}Dettaglio Richiesta ID: {{ richiesta.id }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Dettaglio Richiesta</h2>
            <p class="lead text-muted">
                Stato: 
                {% if richiesta.stato == 'A' %}
                    <span class="badge bg-warning text-dark">In Bozza</span>
                {% elif richiesta.stato == 'B' %}
                    <span class="badge bg-info">In Istruttoria</span>
                {% elif richiesta.stato == 'C' %}
                    <span class="badge bg-success">Istruita</span>
                {% endif %}
            </p>
        </div>
        <div>
             {% if richiesta.stato == 'A' %}
            <a href="{{ url_for('richiesta.controlla_richiesta', richiesta_id=richiesta.id) }}" class="btn btn-success btn-lg" title="Vai alla pagina di controllo finale">
            <i class="fas fa-check-double me-1"></i> Controlla e Trasmetti
            </a>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Riepilogo Dati Generali</h5></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Evento</dt>
                <dd class="col-sm-9">{{ richiesta.evento.nome }}</dd>
                <dt class="col-sm-3">Attività Svolta</dt>
                <dd class="col-sm-9">{{ richiesta.attivita_svolta }}</dd>
            </dl>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-spese">Riepilogo Spese</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-impieghi">Riepilogo Impiego Mezzi</a>
                </li>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-documenti">Riepilogo Documenti</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-spese">
                     {% if richiesta.stato == 'A' %}
                    <a href="{{ url_for('richiesta.crea_spesa', richiesta_id=richiesta.id) }}" class="btn btn-primary mb-3">
                        <i class="fas fa-euro-sign me-1"></i> Aggiungi Spesa
                    </a>
                    {% endif %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th class="text-end">Importo</th>
                                <th class="text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spesa in richiesta.spese %}
                            <tr>
                                <td>{{ spesa.categoria }}</td>
                                <td>{{ spesa.descrizione_spesa }}</td>
                                <td class="text-end">&euro; {{ "%.2f"|format(spesa.importo_richiesto) }}</td>
                                <td class="text-center">
                                    <a href="{{ url_for('richiesta.lista_documenti', spesa_id=spesa.id) }}" class="btn btn-info btn-sm">
                                        <i class="fas fa-file-alt"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted">Nessuna spesa inserita.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="tab-impieghi">
                   {% if richiesta.stato == 'A' %}
                    <a href="{{ url_for('richiesta.crea_impiego', richiesta_id=richiesta.id) }}" class="btn btn-primary mb-3">
                        <i class="fas fa-truck me-1"></i> Aggiungi Impiego Mezzo
                    </a>
                    {% endif %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mezzo</th>
                                <th>Località</th>
                                <th>Periodo</th>
                                <th class="text-end">Km Totali</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for impiego in richiesta.impieghi %}
                            <tr>
                                <td>{{ impiego.mezzo_attrezzatura.targa_inventario }}</td>
                                <td>{{ impiego.localita_impiego }}</td>
                                <td>{{ impiego.data_ora_inizio_impiego.strftime('%d/%m %H:%M') }}</td>
                                <td class="text-end">
                                    {{ "%.2f"|format(impiego.km_totali) if impiego.km_totali else 'N/A' }} km
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted">Nessun impiego registrato.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="tab-documenti">
                    <h5 class="card-title mb-3">Elenco completo dei documenti caricati</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Spesa di Riferimento</th>
                                <th>Tipo Documento</th>
                                <th>Data</th>
                                <th>Fornitore</th>
                                <th class="text-end">Importo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Usiamo un doppio ciclo per scorrere i documenti di ogni spesa #}
                            {% for spesa in richiesta.spese %}
                                {% for doc in spesa.documenti %}
                                <tr>
                                    <td>{{ spesa.descrizione_spesa | truncate(30) }}</td>
                                    <td>{{ doc.get_tipo_documento_display() }}</td>
                                    <td>{{ doc.data_documento.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ doc.fornitore or 'N/D' }}</td>
                                    <td class="text-end">&euro; {{ "%.2f"|format(doc.importo_documento) }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Nessun documento inserito per questa richiesta.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
        </a>
    </div>

{% endblock %}