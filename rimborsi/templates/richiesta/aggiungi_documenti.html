{% extends 'base.html' %}
{% from 'partials/_form_helpers.html' import render_field %}
{% from 'partials/_progress_indicator.html' import render_expense_progress %}
{% from 'partials/_breadcrumb.html' import render_expense_breadcrumb %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            {{ render_expense_breadcrumb(richiesta, "step2", spesa) }}
            
            <h2 class="mb-4">{{ titolo }}</h2>
            
            {{ render_expense_progress(2, "Aggiungi Documenti", "Carica i documenti giustificativi per completare la spesa.", 
               "Spesa creata: " ~ spesa.categoria_display ~ " - â‚¬" ~ "%.2f"|format(spesa.importo_richiesto) ~ " del " ~ spesa.data_spesa.strftime('%d/%m/%Y')) }}
            
            <!-- Rimuoviamo gli alert ridondanti -->
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                {{ form.hidden_tag() }}
                
                <div id="documenti-container">
                    {% for documento in form.documenti %}
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Documento {{ loop.index }}</h6>
                                {% if loop.index > 1 %}
                                    {{ form.remove_document(class_='btn btn-sm btn-outline-danger') }}
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-2">{{ render_field(documento.tipo_documento) }}</div>
                                    <div class="col-md-6 mb-2">{{ render_field(documento.data_documento) }}</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-2">{{ render_field(documento.fornitore) }}</div>
                                    <div class="col-md-6 mb-2">{{ render_field(documento.importo_documento) }}</div>
                                </div>
                                <div class="mb-2">{{ render_field(documento.allegato) }}</div>
                                {{ documento.remove(type="hidden", value="false") }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    {% if num_docs < 10 %}
                        {{ form.add_document(class_='btn btn-outline-primary') }}
                    {% endif %}
                    <span class="text-muted">{{ num_docs }}/10 documenti</span>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('richiesta.dettaglio_richiesta', richiesta_id=richiesta.id) }}" 
                       class="btn btn-secondary">Annulla</a>
                    {{ form.submit(class_='btn btn-success') }}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione dinamica campi importo basata su tipo documento
    document.querySelectorAll('[id*="tipo_documento"]').forEach(function(select) {
        const container = select.closest('.card-body');
        const importoField = container.querySelector('[id*="importo_documento"]');
        const importoContainer = importoField.closest('.col-md-6');
        
        function toggleImporto() {
            const tipo = select.value;
            if (tipo === 'C' || tipo === 'D') { // Autorizzazione o Attestazione
                importoContainer.style.display = 'none';
                importoField.value = '';
                importoField.required = false;
            } else {
                importoContainer.style.display = 'block';
                importoField.required = true;
            }
        }
        
        select.addEventListener('change', toggleImporto);
        toggleImporto();
    });
});
</script>
{% endblock %}