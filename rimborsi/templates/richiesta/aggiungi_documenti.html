{% extends 'base.html' %}
{% from 'partials/_form_helpers.html' import render_field %}
{% from 'partials/_workflow_layout.html' import render_expense_layout %}
{% from 'partials/_action_buttons.html' import render_workflow_step_buttons %}
{% from 'partials/_error_handling.html' import render_form_errors %}

{% block content %}
{% call render_expense_layout(2, titolo, richiesta, spesa, 
    step_description="Carica i documenti giustificativi per completare la spesa.", 
    completion_info="Spesa creata: " ~ spesa.categoria_display ~ " - â‚¬" ~ "%.2f"|format(spesa.importo_richiesto) ~ " del " ~ spesa.data_spesa.strftime('%d/%m/%Y')) %}
    
    {{ render_form_errors(form) }}
    
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        {{ form.hidden_tag() }}
        
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Nuovo Documento</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">{{ render_field(form.tipo_documento) }}</div>
                    <div class="col-md-6 mb-2">{{ render_field(form.data_documento) }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">{{ render_field(form.fornitore) }}</div>
                    <div class="col-md-6 mb-2">{{ render_field(form.importo_documento) }}</div>
                </div>
                <div class="mb-2">{{ render_field(form.allegato) }}</div>
            </div>
        </div>
        
        {{ render_workflow_step_buttons(2, 2, url_for('richiesta.dettaglio_richiesta', richiesta_id=richiesta.id)) }}
    </form>
{% endcall %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione dinamica campi importo basata su tipo documento
    document.querySelectorAll('[id*="tipo_documento"]').forEach(function(select) {
        const container = select.closest('.card-body');
        const importoField = container.querySelector('[id*="importo_documento"]');
        const importoContainer = importoField.closest('.col-md-6');
        
        function toggleImporto() {
            const tipo = select.value;
            if (tipo === 'C' || tipo === 'D') { // Autorizzazione o Attestazione
                importoContainer.style.display = 'none';
                importoField.value = '';
                importoField.required = false;
            } else {
                importoContainer.style.display = 'block';
                importoField.required = true;
            }
        }
        
        select.addEventListener('change', toggleImporto);
        toggleImporto();
    });
});
</script>
{% endblock %}