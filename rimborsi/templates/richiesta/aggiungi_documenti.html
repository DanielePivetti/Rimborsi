{% extends 'base.html' %}
{% from 'partials/_form_helpers.html' import render_field %}
{% from 'partials/_workflow_layout.html' import render_expense_layout %}
{% from 'partials/_action_buttons.html' import render_workflow_step_buttons %}
{% from 'partials/_error_handling.html' import render_form_errors %}

{% block content %}
{% call render_expense_layout(2, titolo, richiesta, spesa, 
    step_description="Carica i documenti giustificativi per completare la spesa.", 
    completion_info="Spesa creata: " ~ spesa.categoria_display ~ " - €" ~ "%.2f"|format(spesa.importo_richiesto) ~ " del " ~ spesa.data_spesa.strftime('%d/%m/%Y')) %}
    
    {{ render_form_errors(form) }}
    
    {# Mostra documenti già aggiunti #}
    {% if spesa.documenti %}
    <div class="alert alert-info mb-3">
        <h6 class="alert-heading"><i class="bi bi-file-earmark-text me-2"></i>Documenti già caricati ({{ spesa.documenti|length }})</h6>
        <ul class="mb-0 small">
        {% for doc in spesa.documenti %}
            <li>
                <strong>{{ doc.get_tipo_documento_display() }}</strong>
                {% if doc.fornitore %} - {{ doc.fornitore }}{% endif %}
                {% if doc.importo_documento %} - € {{ "%.2f"|format(doc.importo_documento) }}{% endif %}
                <span class="text-muted">({{ doc.data_documento.strftime('%d/%m/%Y') }})</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        {{ form.hidden_tag() }}
        
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    {% if spesa.documenti %}Aggiungi altro documento{% else %}Nuovo Documento{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">{{ render_field(form.tipo_documento) }}</div>
                    <div class="col-md-6 mb-2">{{ render_field(form.data_documento) }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">{{ render_field(form.fornitore) }}</div>
                    <div class="col-md-6 mb-2">{{ render_field(form.importo_documento) }}</div>
                </div>
                <div class="mb-2">{{ render_field(form.allegato) }}</div>
            </div>
        </div>
        
        {# Pulsanti per aggiungere documento #}
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('richiesta.dettaglio_richiesta', richiesta_id=richiesta.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                {% if spesa.documenti %}Annulla{% else %}Indietro{% endif %}
            </a>
            <div class="d-flex gap-2">
                <button type="submit" name="aggiungi_altro" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>Salva e aggiungi altro
                </button>
                <button type="submit" name="completa" class="btn btn-success">
                    <i class="bi bi-check-lg me-2"></i>
                    {% if spesa.documenti %}Salva e completa{% else %}Salva documento{% endif %}
                </button>
            </div>
        </div>
    </form>
{% endcall %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione dinamica campi importo basata su tipo documento
    document.querySelectorAll('[id*="tipo_documento"]').forEach(function(select) {
        const container = select.closest('.card-body');
        const importoField = container.querySelector('[id*="importo_documento"]');
        const importoContainer = importoField.closest('.col-md-6');
        
        function toggleImporto() {
            const tipo = select.value;
            if (tipo === 'C' || tipo === 'D') { // Autorizzazione o Attestazione
                importoContainer.style.display = 'none';
                importoField.value = '';
                importoField.required = false;
            } else {
                importoContainer.style.display = 'block';
                importoField.required = true;
            }
        }
        
        select.addEventListener('change', toggleImporto);
        toggleImporto();
    });
});
</script>
{% endblock %}