{% extends 'base.html' %}

{% block title %}Istruttoria Richiesta ID: {{ richiesta.id }}{% endblock %}

{% block content %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Istruttoria Richiesta</h3>
            {% if richiesta.stato == StatoRichiesta.IN_ISTRUTTORIA %}
            <div class="d-flex gap-2">
                <form action="{{ url_for('istruttoria.approva_tutti_importi', richiesta_id=richiesta.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-success btn-lg" 
                            onclick="return confirm('Approvare TUTTI i documenti di tutte le spese?');">
                        <i class="fas fa-check-double me-1"></i> Approva Tutto
                    </button>
                </form>
                <form action="{{ url_for('istruttoria.reset_importi_approvati', richiesta_id=richiesta.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-secondary btn-lg"
                            onclick="return confirm('Resettare TUTTE le verifiche e gli importi approvati?');">
                        <i class="fas fa-undo me-1"></i> Reset Tutto
                    </button>
                </form>
                <a href="#" class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#modalRichiestaIntegrazione">
                    <i class="fas fa-exclamation-circle me-1"></i> Richiedi Integrazione
                </a>
                <a href="{{ url_for('istruttoria.controlla_istruttoria', richiesta_id=richiesta.id) }}" class="btn btn-success btn-lg">
                    <i class="fas fa-flag-checkered me-1"></i> Concludi Istruttoria
                </a>
            </div>
            {% endif %}
        </div>

    {# === Intestazione richiesta === #}
    <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row small">
                <div class="col-md-3"><strong>Codice:</strong> {{ richiesta.codice_uni }}</div>
                <div class="col-md-3"><strong>Organizzazione:</strong> {{ richiesta.organizzazione.nome }}</div>
                <div class="col-md-3"><strong>Evento:</strong> {{ richiesta.evento.nome }}</div>
                <div class="col-md-3"><strong>Stato:</strong> 
                    <span class="badge {% if richiesta.stato == StatoRichiesta.IN_ISTRUTTORIA %}bg-primary{% elif richiesta.stato == StatoRichiesta.ISTRUITA %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ richiesta.stato.label }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    {# === Tabs === #}
    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-documenti">
                        <i class="fas fa-file-alt me-1"></i> 1. Verifica Documenti e Mezzi
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-riepilogo">
                        <i class="fas fa-euro-sign me-1"></i> 2. Riepilogo Spese
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-verbale">
                        <i class="fas fa-file-signature me-1"></i> 3. Verbale
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">

                {# ============================================================ #}
                {# TAB 1 — VERIFICA DOCUMENTI — Accordion per spesa             #}
                {# ============================================================ #}
                <div class="tab-pane fade show active" id="tab-documenti">
                    <div class="alert alert-primary py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Step 1:</strong> Per ogni spesa, verificare i documenti, indicare la conformità e l'importo approvato. Per i mezzi temporanei, verificare la conformità dell'autorizzazione.
                    </div>

                    {% if not richiesta.spese %}
                    <div class="text-center text-muted py-4">Nessuna spesa presente per questa richiesta.</div>
                    {% endif %}

                    <div class="accordion" id="accordionSpese">
                    {% for spesa in richiesta.spese %}
                        {% set verificati = spesa.documenti|selectattr('verificato')|list|length %}
                        {% set totale_docs = spesa.documenti|length %}
                        {% set is_in_istruttoria = (richiesta.stato == StatoRichiesta.IN_ISTRUTTORIA) %}
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading_{{ spesa.id }}">
                                <button class="accordion-button collapsed py-2" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse_{{ spesa.id }}" 
                                        aria-expanded="false" aria-controls="collapse_{{ spesa.id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                        <div>
                                            <span class="badge bg-primary me-2">#{{ spesa.id }}</span>
                                            <strong>{{ spesa.categoria_display }}</strong>
                                            <span class="text-muted ms-2">{{ spesa.data_spesa.strftime('%d/%m/%Y') }}</span>
                                            {% if spesa.descrizione_spesa %}
                                            <small class="text-muted ms-2">— {{ spesa.descrizione_spesa|truncate(40) }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center gap-3">
                                            {# Badge importo richiesto #}
                                            <span class="text-nowrap">
                                                Richiesto: <strong>&euro; {{ "%.2f"|format(spesa.importo_richiesto) }}</strong>
                                            </span>
                                            {# Badge importo approvato #}
                                            {% if spesa.importo_approvato is not none %}
                                            <span class="text-nowrap">
                                                Approvato: <strong class="text-success">&euro; {{ "%.2f"|format(spesa.importo_approvato) }}</strong>
                                            </span>
                                            {% endif %}
                                            {# Badge documenti verificati #}
                                            {% if spesa.tutti_documenti_verificati %}
                                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>{{ verificati }}/{{ totale_docs }}</span>
                                            {% elif verificati > 0 %}
                                                <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-circle me-1"></i>{{ verificati }}/{{ totale_docs }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ verificati }}/{{ totale_docs }} doc</span>
                                            {% endif %}
                                            {# Warning pasti #}
                                            {% if spesa.supera_limite_pasto %}
                                                <span class="badge bg-danger" title="Costo pro-capite: &euro; {{ '%.2f'|format(spesa.costo_per_volontario) }}">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>&gt; &euro;15/vol
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse_{{ spesa.id }}" class="accordion-collapse collapse" 
                                 aria-labelledby="heading_{{ spesa.id }}" data-bs-parent="#accordionSpese">
                                <div class="accordion-body p-3">
                                    
                                    {# === Form POST per la verifica documenti di questa spesa === #}
                                    <form action="{{ url_for('istruttoria.salva_verifica_spesa', spesa_id=spesa.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        
                                        {% if spesa.documenti %}
                                        <table class="table table-sm table-hover mb-3">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:50px">ID</th>
                                                    <th>Tipo</th>
                                                    <th>Data</th>
                                                    <th>Fornitore</th>
                                                    <th class="text-end">Importo Doc.</th>
                                                    <th class="text-center" style="width:90px">Verificato</th>
                                                    <th style="width:130px">Conforme</th>
                                                    <th style="width:130px">Imp. Approvato</th>
                                                    <th style="width:180px">Note</th>
                                                    <th class="text-center" style="width:50px">File</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for doc in spesa.documenti %}
                                                <tr class="{% if doc.conforme == false %}table-danger{% elif doc.conforme == true %}table-success{% endif %}">
                                                    <td><small>{{ doc.id }}</small></td>
                                                    <td>{{ doc.get_tipo_documento_display() }}</td>
                                                    <td>{{ doc.data_documento.strftime('%d/%m/%Y') }}</td>
                                                    <td>{{ doc.fornitore or '—' }}</td>
                                                    <td class="text-end fw-bold">&euro; {{ "%.2f"|format(doc.importo_documento) }}</td>
                                                    <td class="text-center">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="verificato_{{ doc.id }}"
                                                               {% if doc.verificato %}checked{% endif %}
                                                               {% if not is_in_istruttoria %}disabled{% endif %}>
                                                    </td>
                                                    <td>
                                                        <select name="conforme_{{ doc.id }}" 
                                                                class="form-select form-select-sm conforme-select"
                                                                data-doc-id="{{ doc.id }}"
                                                                data-importo="{{ doc.importo_documento }}"
                                                                {% if not is_in_istruttoria %}disabled{% endif %}>
                                                            <option value="" {% if doc.conforme is none %}selected{% endif %}>—</option>
                                                            <option value="true" {% if doc.conforme == true %}selected{% endif %}>Sì</option>
                                                            <option value="false" {% if doc.conforme == false %}selected{% endif %}>No</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" step="0.01" min="0"
                                                               name="importo_approvato_{{ doc.id }}"
                                                               id="importo_approvato_{{ doc.id }}"
                                                               class="form-control form-control-sm"
                                                               value="{{ '%.2f'|format(doc.importo_approvato) if doc.importo_approvato is not none else '' }}"
                                                               placeholder="&euro;"
                                                               {% if not is_in_istruttoria %}disabled{% endif %}>
                                                    </td>
                                                    <td>
                                                        <input type="text" 
                                                               name="note_documento_{{ doc.id }}"
                                                               class="form-control form-control-sm"
                                                               value="{{ doc.note_istruttoria or '' }}"
                                                               placeholder="Note..."
                                                               {% if not is_in_istruttoria %}disabled{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        {% if doc.nome_file %}
                                                        <a href="{{ url_for('richiesta.download_documento', documento_id=doc.id) }}" 
                                                           class="btn btn-outline-info btn-sm" title="Scarica">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        {% else %}
                                                        <span class="text-muted">—</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% else %}
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-folder-open me-1"></i> Nessun documento per questa spesa.
                                        </div>
                                        {% endif %}
                                        {# === Dettaglio Impiego Mezzo collegato === #}
                                        {% if spesa.impiego %}
                                        {% set impiego = spesa.impiego %}
                                        {% set mezzo = impiego.mezzo_attrezzatura %}
                                        <div class="card border-success mb-3 mt-2">
                                            <div class="card-header bg-success bg-opacity-10 py-2">
                                                <i class="fas fa-truck me-1"></i>
                                                <strong>Impiego Mezzo</strong>
                                                {% if mezzo.is_temporary %}
                                                    <span class="badge bg-warning text-dark ms-2">TEMPORANEO</span>
                                                {% endif %}
                                            </div>
                                            <div class="card-body py-2 bg-success bg-opacity-10">
                                                <div class="row small">
                                                    <div class="col-md-3">
                                                        <strong>Mezzo:</strong> {{ mezzo.targa_inventario }}
                                                        <div class="text-muted">{{ mezzo.descrizione or 'N/D' }}</div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Località:</strong> {{ impiego.localita_impiego or '—' }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Periodo:</strong>
                                                        {% if impiego.data_ora_inizio_impiego %}
                                                            {{ impiego.data_ora_inizio_impiego.strftime('%d/%m %H:%M') }}
                                                        {% endif %}
                                                        {% if impiego.data_ora_fine_impiego %}
                                                            — {{ impiego.data_ora_fine_impiego.strftime('%d/%m %H:%M') }}
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Km Totali:</strong> {{ "%.2f"|format(impiego.km_totali) if impiego.km_totali else 'N/A' }} km
                                                    </div>
                                                </div>

                                                {# Conformità autorizzazione per mezzi temporanei #}
                                                {% if mezzo.is_temporary %}
                                                <hr class="my-2">
                                                <div class="row align-items-end">
                                                    <div class="col-md-3">
                                                        <strong class="small">Autorizzazione:</strong>
                                                        <div class="small">
                                                            {{ mezzo.authorizing_entity or '—' }}
                                                            {% if mezzo.authorization_date %}
                                                                <span class="text-muted">({{ mezzo.authorization_date.strftime('%d/%m/%Y') }})</span>
                                                            {% endif %}
                                                        </div>
                                                        {% if mezzo.authorization_document %}
                                                            <a href="{{ url_for('richiesta.download_authorization', mezzo_id=mezzo.id) }}" 
                                                               class="btn btn-outline-info btn-sm mt-1">
                                                                <i class="fas fa-download me-1"></i>Scarica allegato
                                                            </a>
                                                        {% else %}
                                                            <div class="text-danger small">Documento mancante</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label small fw-bold mb-1">Conformità:</label>
                                                        <select name="authorization_conforme" form="form-conformita-{{ mezzo.id }}"
                                                                class="form-select form-select-sm"
                                                                {% if not is_in_istruttoria %}disabled{% endif %}>
                                                            <option value="" {% if mezzo.authorization_conforme is none %}selected{% endif %}>—</option>
                                                            <option value="true" {% if mezzo.authorization_conforme == true %}selected{% endif %}>Conforme</option>
                                                            <option value="false" {% if mezzo.authorization_conforme == false %}selected{% endif %}>Non conforme</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small fw-bold mb-1">Note autorizzazione:</label>
                                                        <input type="text" name="authorization_note" form="form-conformita-{{ mezzo.id }}"
                                                               class="form-control form-control-sm"
                                                               value="{{ mezzo.authorization_note or '' }}"
                                                               placeholder="Note..."
                                                               {% if not is_in_istruttoria %}disabled{% endif %}>
                                                    </div>
                                                    <div class="col-md-2 text-end">
                                                        <form id="form-conformita-{{ mezzo.id }}" 
                                                              action="{{ url_for('istruttoria.salva_conformita_autorizzazione', mezzo_id=mezzo.id) }}" 
                                                              method="POST">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <input type="hidden" name="richiesta_id" value="{{ richiesta.id }}">
                                                            {% if is_in_istruttoria %}
                                                            <button type="submit" class="btn btn-primary btn-sm">
                                                                <i class="fas fa-save me-1"></i>Salva
                                                            </button>
                                                            {% endif %}
                                                        </form>
                                                        {% if mezzo.authorization_conforme is none %}
                                                            <span class="badge bg-secondary mt-1">Da valutare</span>
                                                        {% elif mezzo.authorization_conforme %}
                                                            <span class="badge bg-success mt-1">Conforme</span>
                                                        {% else %}
                                                            <span class="badge bg-danger mt-1">Non conforme</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        {# Note istruttoria per la spesa #}
                                        <div class="row mb-2">
                                            <div class="col-md-8">
                                                <label class="form-label small fw-bold">Note istruttoria per questa spesa:</label>
                                                <input type="text" name="note_spesa" 
                                                       class="form-control form-control-sm"
                                                       value="{{ spesa.note_istruttoria or '' }}"
                                                       placeholder="Note generali sulla spesa..."
                                                       {% if not is_in_istruttoria %}disabled{% endif %}>
                                            </div>
                                        </div>

                                        {# Pulsanti azione #}
                                        {% if is_in_istruttoria and spesa.documenti %}
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save me-1"></i> Salva Verifica
                                                </button>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="submit" formaction="{{ url_for('istruttoria.approva_tutti_documenti_spesa', spesa_id=spesa.id) }}" 
                                                        class="btn btn-success btn-sm"
                                                        onclick="return confirm('Approvare tutti i documenti di questa spesa?');">
                                                    <i class="fas fa-check-double me-1"></i> Approva Tutti
                                                </button>
                                                <button type="submit" formaction="{{ url_for('istruttoria.reset_verifica_spesa', spesa_id=spesa.id) }}" 
                                                        class="btn btn-outline-secondary btn-sm"
                                                        onclick="return confirm('Resettare la verifica di tutti i documenti?');">
                                                    <i class="fas fa-undo me-1"></i> Reset
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </form>

                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                {# Fine Tab Documenti #}

                {# ============================================================ #}
                {# TAB 2 — RIEPILOGO SPESE — Read-only con totali              #}
                {# ============================================================ #}
                <div class="tab-pane fade" id="tab-riepilogo">
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Riepilogo:</strong> Panoramica di tutte le spese con lo stato di verifica. Gli importi approvati vengono calcolati automaticamente dai documenti.
                    </div>

                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Categoria</th>
                                <th>Data</th>
                                <th>Descrizione</th>
                                <th class="text-end">Richiesto</th>
                                <th class="text-end">Approvato</th>
                                <th class="text-end">Differenza</th>
                                <th class="text-center">Documenti</th>
                                <th class="text-center">Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(tot_richiesto=0, tot_approvato=0) %}
                            {% for spesa in richiesta.spese %}
                            {% set approvato = spesa.importo_approvato or 0 %}
                            {% set differenza = approvato - spesa.importo_richiesto %}
                            {% set ns.tot_richiesto = ns.tot_richiesto + spesa.importo_richiesto %}
                            {% set ns.tot_approvato = ns.tot_approvato + approvato %}
                            <tr class="{% if differenza < 0 %}table-warning{% elif spesa.tutti_documenti_verificati %}table-success{% endif %}">
                                <td><span class="badge bg-primary">{{ spesa.id }}</span></td>
                                <td>{{ spesa.categoria_display }}</td>
                                <td>{{ spesa.data_spesa.strftime('%d/%m/%Y') }}</td>
                                <td>{{ spesa.descrizione_spesa or '—' }}</td>
                                <td class="text-end">&euro; {{ "%.2f"|format(spesa.importo_richiesto) }}</td>
                                <td class="text-end fw-bold">
                                    {% if spesa.importo_approvato is not none %}
                                        &euro; {{ "%.2f"|format(spesa.importo_approvato) }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if differenza < 0 %}text-danger{% elif differenza == 0 %}text-success{% endif %}">
                                    {% if spesa.importo_approvato is not none %}
                                        &euro; {{ "%.2f"|format(differenza) }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% set verificati = spesa.documenti|selectattr('verificato')|list|length %}
                                    {% set totale_docs = spesa.documenti|length %}
                                    {% if spesa.tutti_documenti_verificati %}
                                        <span class="badge bg-success">{{ verificati }}/{{ totale_docs }}</span>
                                    {% elif verificati > 0 %}
                                        <span class="badge bg-warning text-dark">{{ verificati }}/{{ totale_docs }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ verificati }}/{{ totale_docs }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if spesa.tutti_documenti_verificati and spesa.importo_approvato is not none %}
                                        <i class="fas fa-check-circle text-success" title="Completata"></i>
                                    {% elif spesa.documenti|selectattr('verificato')|list|length > 0 %}
                                        <i class="fas fa-clock text-warning" title="In corso"></i>
                                    {% else %}
                                        <i class="fas fa-hourglass-start text-muted" title="Da iniziare"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <td colspan="4" class="fw-bold">TOTALE</td>
                                <td class="text-end fw-bold">&euro; {{ "%.2f"|format(ns.tot_richiesto) }}</td>
                                <td class="text-end fw-bold">&euro; {{ "%.2f"|format(ns.tot_approvato) }}</td>
                                <td class="text-end fw-bold 
                                    {% if ns.tot_approvato - ns.tot_richiesto < 0 %}text-warning{% else %}text-success{% endif %}">
                                    &euro; {{ "%.2f"|format(ns.tot_approvato - ns.tot_richiesto) }}
                                </td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>

                    {# Riepilogo per tipologia #}
                    <h6 class="mt-4 mb-2"><i class="fas fa-chart-pie me-1"></i> Riepilogo per Tipologia</h6>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Tipologia</th>
                                <th class="text-end">Richiesto</th>
                                <th class="text-end">Approvato</th>
                                <th class="text-end">Differenza</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set categorie_viste = {} %}
                            {% for spesa in richiesta.spese %}
                                {% set cat = spesa.categoria_display %}
                                {% if cat not in categorie_viste %}
                                    {% set _ = categorie_viste.update({cat: {'richiesto': 0, 'approvato': 0}}) %}
                                {% endif %}
                                {% set _ = categorie_viste[cat].update({'richiesto': categorie_viste[cat]['richiesto'] + spesa.importo_richiesto}) %}
                                {% set _ = categorie_viste[cat].update({'approvato': categorie_viste[cat]['approvato'] + (spesa.importo_approvato or 0)}) %}
                            {% endfor %}
                            {% for cat, vals in categorie_viste.items() %}
                            <tr>
                                <td><strong>{{ cat }}</strong></td>
                                <td class="text-end">&euro; {{ "%.2f"|format(vals['richiesto']) }}</td>
                                <td class="text-end">&euro; {{ "%.2f"|format(vals['approvato']) }}</td>
                                <td class="text-end {% if vals['approvato'] - vals['richiesto'] < 0 %}text-danger{% endif %}">
                                    &euro; {{ "%.2f"|format(vals['approvato'] - vals['richiesto']) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {# Note istruttoria generali della richiesta #}
                    <form action="{{ url_for('istruttoria.salva_istruttoria', richiesta_id=richiesta.id) }}" method="POST" class="mt-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Note generali istruttoria:</label>
                                <textarea name="note_istruttoria" class="form-control" rows="2"
                                          {% if richiesta.stato != StatoRichiesta.IN_ISTRUTTORIA %}disabled{% endif %}>{{ richiesta.note_istruttoria or '' }}</textarea>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                {% if richiesta.stato == StatoRichiesta.IN_ISTRUTTORIA %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Salva Note
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
                {# Fine Tab Riepilogo #}

                {# ============================================================ #}
                {# TAB 3 — VERBALE                                              #}
                {# ============================================================ #}
                <div class="tab-pane fade" id="tab-verbale">
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Verbale di Istruttoria</strong>
                        <p class="mb-0 mt-2">Questa sezione è in fase di sviluppo e conterrà il verbale conclusivo dell'istruttoria.</p>
                    </div>
                </div>
                {# Fine Tab Verbale #}

            </div>
        </div>
    </div>

    {# === Barra azioni inferiore === #}
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
            </a>
            <a href="{{ url_for('istruttoria.visualizza_comunicazioni', richiesta_id=richiesta.id) }}" 
               class="btn btn-outline-primary ms-2">
                <i class="fas fa-history me-1"></i> Storico richiesta
            </a>
        </div>
    </div>

    {% include 'istruttoria/_modal_richiesta_integrazione.html' %}
   
{% endblock %}

{% block scripts %}
<script>
// JS minimale: quando conforme = "Sì", pre-compila importo_approvato con importo_documento
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.conforme-select').forEach(function(sel) {
        sel.addEventListener('change', function() {
            var docId = this.dataset.docId;
            var importoField = document.getElementById('importo_approvato_' + docId);
            if (this.value === 'true' && importoField && !importoField.value) {
                importoField.value = parseFloat(this.dataset.importo).toFixed(2);
            }
        });
    });
});
</script>
{% endblock %}
